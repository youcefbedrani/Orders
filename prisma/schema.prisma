// Prisma schema for YouCan Order Automation

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               String    @id @default(cuid())
  email            String    @unique
  password         String
  name             String?
  createdAt        DateTime  @default(now())
  role             String    @default("USER") // 'USER', 'ADMIN', 'BLOCKED'
  
  // Email verification
  emailVerified    Boolean   @default(false)
  verificationCode String?
  codeExpiresAt    DateTime?
  codeAttempts     Int       @default(0)
  
  termsAccepted    Boolean   @default(false)
  termsAcceptedAt  DateTime?
  jobs             Job[]
  campaigns        Campaign[]

  @@index([email])
}

model Job {
  id             String    @id @default(cuid())
  userId         String
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Job type and status
  type           String    @default("PIXEL_WARMING") // PIXEL_WARMING
  status         String    @default("PENDING") // PENDING, RUNNING, COMPLETED, FAILED, CANCELLED
  
  // Campaign details
  url            String
  mode           String    // 'random' or 'excel'
  orderCount     Int
  customPrice    Int?
  fileName       String?
  fileUrl        String?
  fileSize       Int?
  
  // Customer data (JSON string for Excel mode)
  customerData   String?   // JSON array of customer objects
  
  // Progress tracking
  processedCount Int       @default(0)
  successCount   Int       @default(0)
  failedCount    Int       @default(0)
  
  // Timing
  startedAt      DateTime?
  completedAt    DateTime?
  duration       Int?      // seconds
  
  // Results and errors
  results        String?   // JSON string with detailed results
  error          String?
  
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model Campaign {
  id           String   @id @default(cuid())
  url          String
  orderCount   Int
  successCount Int
  failedCount  Int
  successRate  Float
  duration     Int      // in seconds
  mode         String   // 'random' or 'excel'
  fileName     String?  // Name of the Excel file used (if any)
  fileUrl      String?  // Path to uploaded Excel file
  fileSize     Int?     // File size in bytes
  results      String?  // JSON string with detailed results (orders, pixels fired)
  createdAt    DateTime @default(now())
  userId       String?
  user         User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([createdAt])
}
